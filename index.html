<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Douyin to ALAC (Speed Demon)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FFmpeg -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <style>
        @keyframes pulse-fast { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-fast { animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="bg-black text-slate-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Icons
        const Icon = ({ d, size=24, className="" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{__html:d}} />;
        const icons = {
            zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
            download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>',
            loader: '<path d="M21 12a9 9 0 1 1-6.219-8.56"/>',
            check: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'
        };

        const DouyinConverter = () => {
            const [url, setUrl] = useState('');
            const [status, setStatus] = useState('idle');
            const [msg, setMsg] = useState('');
            const [progress, setProgress] = useState(0);
            const [videoInfo, setVideoInfo] = useState(null);
            const [downloadLink, setDownloadLink] = useState(null);
            
            const ffmpegRef = useRef(null);
            const ffmpegReady = useRef(false);

            // 1. 極速優化：網頁開啟時立即預載入 FFmpeg
            useEffect(() => {
                const initFFmpeg = async () => {
                    if (window.FFmpeg && !ffmpegRef.current) {
                        try {
                            const { createFFmpeg } = window.FFmpeg;
                            // 使用單線程 (core-st) 以確保最大兼容性
                            const ffmpeg = createFFmpeg({ 
                                log: false, 
                                corePath: 'https://unpkg.com/@ffmpeg/core-st@0.11.1/dist/ffmpeg-core.js',
                                mainName: 'main'
                            });
                            ffmpegRef.current = ffmpeg;
                            await ffmpeg.load();
                            ffmpegReady.current = true;
                            console.log("FFmpeg Engine Ready (Preloaded)");
                        } catch (e) {
                            console.error("FFmpeg Preload Error", e);
                        }
                    }
                };
                // 稍微延遲一下，讓 UI 先渲染出來再載入重型腳本
                setTimeout(initFFmpeg, 500);
            }, []);

            // 2. 極速優化：並行競速下載 (Race)
            const downloadWithRace = async (videoUrl) => {
                // 強制轉 HTTPS
                const secureUrl = videoUrl.replace('http:', 'https:');
                
                // 定義多個下載通道
                const proxies = [
                    u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`, // 通常最快
                    u => `https://corsproxy.io/?${encodeURIComponent(u)}`, // 穩定備用
                    u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}` // 慢但可用
                ];

                // 建立一組 Promise，同時發出請求
                const requests = proxies.map(proxyFn => 
                    new Promise(async (resolve, reject) => {
                        try {
                            const res = await fetch(proxyFn(secureUrl));
                            if (!res.ok) throw new Error('Network response was not ok');
                            const blob = await res.blob();
                            if (blob.size < 2000) throw new Error('File too small');
                            resolve(blob);
                        } catch (e) {
                            reject(e);
                        }
                    })
                );

                // Promise.any 會等待「第一個成功」的結果，忽略失敗的 (直到全部失敗)
                try {
                    setMsg('多線路競速下載中...');
                    const winnerBlob = await Promise.any(requests);
                    return await winnerBlob.arrayBuffer();
                } catch (err) {
                    throw new Error("所有下載線路皆失敗，請稍後再試");
                }
            };

            const process = async () => {
                const linkMatch = url.match(/(https?:\/\/[^\s]+)/);
                if (!linkMatch) return setMsg('無效連結');
                const cleanUrl = linkMatch[0];

                setStatus('working');
                setProgress(10);
                setDownloadLink(null);

                try {
                    // Step A: 解析 API (也是用 Race 機制加速)
                    setMsg('解析影片資訊...');
                    const api1 = fetch(`https://api.pearktrue.cn/api/video/douyin/?url=${encodeURIComponent(cleanUrl)}`).then(r=>r.json()).then(d=>d.code===200?d.data:Promise.reject());
                    const api2 = fetch(`https://api.kuaishouapi.com/douyin/index?url=${encodeURIComponent(cleanUrl)}`).then(r=>r.json()).then(d=>d.code===200?{url:d.data.url||d.data.play, title:d.data.desc, cover:d.data.cover}:Promise.reject());
                    
                    const videoData = await Promise.any([api1, api2].map(p => p.catch(e => Promise.reject(e))));
                    
                    const playUrl = videoData.url || videoData.playUrl; // 兼容不同 API 格式
                    if (!playUrl) throw new Error('解析失敗');

                    setVideoInfo({
                        title: videoData.title || 'Unknown Title',
                        cover: videoData.cover,
                        author: videoData.author || 'Douyin User'
                    });

                    // Step B: 極速下載
                    setProgress(40);
                    const buffer = await downloadWithRace(playUrl);

                    // Step C: 轉換
                    setProgress(70);
                    setMsg('FFmpeg 轉碼中...');
                    
                    if (!ffmpegReady.current) {
                        setMsg('正在喚醒轉換引擎...');
                        // 如果還沒預載完，這裡再等一下
                        if (!ffmpegRef.current) {
                             const { createFFmpeg } = window.FFmpeg;
                             ffmpegRef.current = createFFmpeg({ log: false, corePath: 'https://unpkg.com/@ffmpeg/core-st@0.11.1/dist/ffmpeg-core.js', mainName: 'main' });
                        }
                        if (!ffmpegRef.current.isLoaded()) await ffmpegRef.current.load();
                    }

                    const ffmpeg = ffmpegRef.current;
                    ffmpeg.FS('writeFile', 'in.mp4', new Uint8Array(buffer));
                    
                    // -vn: 去除視頻 (極快)
                    // -c:a copy: 直接複製音軌 (如果是 AAC 則無需重編碼，這是最最最快的方法)
                    // 但因為你要 ALAC (.m4a)，我們必須轉碼: -c:a alac
                    await ffmpeg.run('-i', 'in.mp4', '-vn', '-c:a', 'alac', 'out.m4a');

                    const data = ffmpeg.FS('readFile', 'out.m4a');
                    const blob = new Blob([data.buffer], { type: 'audio/mp4' });
                    setDownloadLink(URL.createObjectURL(blob));
                    
                    setProgress(100);
                    setStatus('done');
                    setMsg('完成！');

                    // Cleanup
                    ffmpeg.FS('unlink', 'in.mp4');
                    ffmpeg.FS('unlink', 'out.m4a');

                } catch (e) {
                    console.error(e);
                    setStatus('error');
                    setMsg('失敗: ' + (e.message || '未知錯誤'));
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center relative overflow-hidden p-4">
                    {/* Background */}
                    <div className="absolute inset-0 bg-slate-950">
                        <div className="absolute top-[-20%] left-[-20%] w-[80vw] h-[80vw] bg-indigo-500/10 rounded-full blur-[100px] animate-blob"></div>
                        <div className="absolute bottom-[-20%] right-[-20%] w-[80vw] h-[80vw] bg-purple-500/10 rounded-full blur-[100px] animate-blob animation-delay-2000"></div>
                    </div>

                    <div className="w-full max-w-md glass rounded-2xl p-6 shadow-2xl relative z-10 border-t border-white/10">
                        <div className="text-center mb-6">
                            <div className="w-12 h-12 bg-gradient-to-tr from-indigo-500 to-purple-600 rounded-xl mx-auto flex items-center justify-center shadow-lg shadow-indigo-500/30 mb-3">
                                <Icon d={icons.zap} className="text-white" />
                            </div>
                            <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">極速轉換器</h1>
                            <p className="text-xs text-slate-500 mt-1">Parallel Downloading • Preloaded Core</p>
                        </div>

                        <div className="space-y-4">
                            <div className="relative">
                                <input 
                                    value={url}
                                    onChange={e => setUrl(e.target.value)}
                                    placeholder="貼上抖音連結..."
                                    className="w-full bg-black/50 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all outline-none text-white placeholder-slate-600"
                                />
                                <button 
                                    onClick={() => navigator.clipboard.readText().then(t => setUrl(t))}
                                    className="absolute right-2 top-2 p-1.5 text-xs bg-slate-800 hover:bg-slate-700 rounded text-slate-300 transition-colors"
                                >
                                    貼上
                                </button>
                            </div>

                            {status === 'working' && (
                                <div className="space-y-3 py-2">
                                    {videoInfo && (
                                        <div className="flex items-center gap-3 bg-slate-800/50 p-2 rounded-lg border border-slate-700/50">
                                            <img src={videoInfo.cover} className="w-10 h-10 rounded bg-slate-700 object-cover"/>
                                            <div className="min-w-0">
                                                <p className="text-xs font-bold text-slate-200 truncate">{videoInfo.title}</p>
                                                <p className="text-[10px] text-slate-500">@{videoInfo.author}</p>
                                            </div>
                                        </div>
                                    )}
                                    <div className="h-1 w-full bg-slate-800 rounded-full overflow-hidden">
                                        <div className="h-full bg-indigo-500 transition-all duration-300" style={{width: `${progress}%`}}></div>
                                    </div>
                                    <div className="flex items-center justify-center gap-2 text-xs text-indigo-300 animate-pulse">
                                        <Icon d={icons.loader} size={12} className="animate-spin"/> {msg}
                                    </div>
                                </div>
                            )}

                            {status === 'error' && (
                                <div className="bg-red-500/10 border border-red-500/20 text-red-300 text-xs p-3 rounded-lg text-center">
                                    {msg}
                                </div>
                            )}

                            {status === 'done' && downloadLink && (
                                <a 
                                    href={downloadLink}
                                    download={`${videoInfo?.title || 'audio'}.m4a`}
                                    className="block w-full py-3 bg-emerald-500 hover:bg-emerald-400 text-white font-bold rounded-xl text-center shadow-lg shadow-emerald-500/20 transition-all flex items-center justify-center gap-2"
                                >
                                    <Icon d={icons.download} /> 下載 ALAC 音訊
                                </a>
                            )}

                            {status !== 'working' && status !== 'done' && (
                                <button 
                                    onClick={process}
                                    disabled={!url}
                                    className={`w-full py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 ${
                                        url 
                                        ? 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:scale-[1.02] shadow-lg shadow-indigo-500/20 text-white' 
                                        : 'bg-slate-800 text-slate-500 cursor-not-allowed'
                                    }`}
                                >
                                    <Icon d={icons.zap} size={18} /> 開始極速轉換
                                </button>
                            )}
                            
                            {status === 'done' && (
                                <button onClick={() => { setStatus('idle'); setUrl(''); }} className="w-full text-xs text-slate-500 hover:text-white py-2">
                                    轉換下一首
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DouyinConverter />);
    </script>
</body>
</html>