<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Douyin to ALAC (Smart Switcher V2.4)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FFmpeg -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <style>
        @keyframes pulse-fast { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-fast { animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .progress-bar { transition: width 0.3s ease-out; }
        .log-area::-webkit-scrollbar { width: 4px; }
        .log-area::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .log-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
    </style>
</head>
<body class="bg-black text-slate-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ d, size=24, className="" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{__html:d}} />;
        const icons = {
            zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
            download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>',
            loader: '<path d="M21 12a9 9 0 1 1-6.219-8.56"/>',
            alert: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>',
            external: '<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>'
        };

        const DouyinConverter = () => {
            const [url, setUrl] = useState('');
            const [status, setStatus] = useState('idle');
            const [logs, setLogs] = useState([]);
            const [progress, setProgress] = useState(0); 
            const [videoInfo, setVideoInfo] = useState(null);
            const [downloadLink, setDownloadLink] = useState(null);
            const [showRescue, setShowRescue] = useState(false);
            
            const ffmpegRef = useRef(null);
            const ffmpegReady = useRef(false);

            const addLog = (text, type = 'info') => {
                const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                setLogs(prev => [...prev, { text, type, time }]);
            };

            // 1. FFmpeg Preload
            useEffect(() => {
                const initFFmpeg = async () => {
                    if (window.FFmpeg && !ffmpegRef.current) {
                        try {
                            const { createFFmpeg } = window.FFmpeg;
                            const ffmpeg = createFFmpeg({ 
                                log: false, 
                                corePath: 'https://unpkg.com/@ffmpeg/core-st@0.11.1/dist/ffmpeg-core.js',
                                mainName: 'main'
                            });
                            ffmpegRef.current = ffmpeg;
                            await ffmpeg.load();
                            ffmpegReady.current = true;
                            console.log("FFmpeg Ready");
                        } catch (e) { console.error("Preload Error", e); }
                    }
                };
                setTimeout(initFFmpeg, 500);
            }, []);

            const fetchJsonSafe = async (targetUrl, sourceName) => {
                // ... (Parsing logic same as before) ...
                try {
                    const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`);
                    if (res.ok) return await res.json();
                } catch(e) {}
                try {
                    const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(targetUrl)}`);
                    if (res.ok) return await res.json();
                } catch(e) {}
                throw new Error(`${sourceName} 無回應`);
            };

            // 2. Sequential Download (Waterfall) - The Key Fix
            const downloadSequentially = async (videoUrl) => {
                const secureUrl = videoUrl.replace('http:', 'https:');
                
                // Priority List: Best proxies first
                const proxies = [
                    { name: 'CodeTabs', fn: u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}` },
                    { name: 'CorsProxy', fn: u => `https://corsproxy.io/?${encodeURIComponent(u)}` },
                    { name: 'AllOrigins', fn: u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}` }
                ];

                for (let i = 0; i < proxies.length; i++) {
                    const proxy = proxies[i];
                    addLog(`嘗試下載線路 ${i + 1}/${proxies.length}: [${proxy.name}]...`, 'info');
                    setProgress(0);

                    try {
                        // 15s Timeout for each attempt
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000);

                        const res = await fetch(proxy.fn(secureUrl), { signal: controller.signal });
                        clearTimeout(timeoutId);

                        if (!res.ok) throw new Error(`HTTP ${res.status}`);

                        const contentLength = res.headers.get('content-length');
                        const total = contentLength ? parseInt(contentLength, 10) : 0;
                        let loaded = 0;

                        const reader = res.body.getReader();
                        const chunks = [];

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            chunks.push(value);
                            loaded += value.length;
                            
                            // Visual Progress
                            if (total) {
                                const percent = (loaded / total) * 100;
                                // Map 0-100 download to 30-80 UI
                                setProgress(30 + (percent * 0.5));
                            } else {
                                // Indeterminate progress if no content-length
                                setProgress(prev => (prev < 75 ? prev + 1 : prev));
                            }
                        }

                        // Combine
                        const buffer = new Uint8Array(loaded);
                        let position = 0;
                        for(let chunk of chunks) {
                            buffer.set(chunk, position);
                            position += chunk.length;
                        }

                        addLog(`線路 [${proxy.name}] 下載成功！`, 'success');
                        return buffer.buffer; // Success! Return immediately

                    } catch (e) {
                        addLog(`[${proxy.name}] 失敗: ${e.name === 'AbortError' ? '連線逾時' : e.message}`, 'error');
                        // Continue to next proxy loop...
                    }
                }

                throw new Error("所有線路均無法連線，請嘗試手動下載");
            };

            const process = async () => {
                const linkMatch = url.match(/(https?:\/\/[^\s]+)/);
                if (!linkMatch) return setLogs([{text: '錯誤: 無效的連結', type: 'error'}]);
                const cleanUrl = linkMatch[0];

                setStatus('working');
                setProgress(5);
                setLogs([]); 
                setDownloadLink(null);
                setVideoInfo(null);
                setShowRescue(false);

                addLog('正在初始化解析引擎...', 'info');

                try {
                    // Step A: Parse (Race is fine here, small data)
                    const providers = [
                        { name: 'Peark', fn: () => fetchJsonSafe(`https://api.pearktrue.cn/api/video/douyin/?url=${encodeURIComponent(cleanUrl)}`, 'Peark').then(d => ({url: d.data.url, title: d.data.title, cover: d.data.cover, author: d.data.author})) },
                        { name: 'Kuaishou', fn: () => fetchJsonSafe(`https://api.kuaishouapi.com/douyin/index?url=${encodeURIComponent(cleanUrl)}`, 'KS').then(d => ({url: d.data.url||d.data.play, title: d.data.desc, cover: d.data.cover, author: d.data.author})) },
                        { name: 'TenAPI', fn: () => fetchJsonSafe(`https://tenapi.cn/v2/video?url=${encodeURIComponent(cleanUrl)}`, 'Ten').then(d => ({url: d.data.url, title: d.data.title, cover: d.data.cover, author: d.data.author})) }
                    ];

                    const videoData = await Promise.any(providers.map(p => p.fn()));
                    
                    if (!videoData.url) throw new Error('解析失敗');
                    
                    setVideoInfo({ ...videoData, rawUrl: videoData.url });
                    addLog(`已解析: ${videoData.title.substring(0,10)}...`, 'info');
                    setProgress(30);

                    // Step B: Sequential Download (The Fix)
                    const buffer = await downloadSequentially(videoData.url);

                    // Step C: Convert
                    setProgress(85);
                    addLog('啟動轉碼引擎...', 'info');
                    
                    if (!ffmpegReady.current) {
                        if (!ffmpegRef.current) {
                             const { createFFmpeg } = window.FFmpeg;
                             ffmpegRef.current = createFFmpeg({ log: false, corePath: 'https://unpkg.com/@ffmpeg/core-st@0.11.1/dist/ffmpeg-core.js', mainName: 'main' });
                        }
                        if (!ffmpegRef.current.isLoaded()) await ffmpegRef.current.load();
                    }

                    const ffmpeg = ffmpegRef.current;
                    ffmpeg.FS('writeFile', 'in.mp4', new Uint8Array(buffer));
                    await ffmpeg.run('-i', 'in.mp4', '-vn', '-c:a', 'alac', 'out.m4a');
                    const data = ffmpeg.FS('readFile', 'out.m4a');
                    setDownloadLink(URL.createObjectURL(new Blob([data.buffer], { type: 'audio/mp4' })));
                    
                    setProgress(100);
                    setStatus('done');
                    addLog('全部完成！', 'success');
                    
                    try { ffmpeg.FS('unlink', 'in.mp4'); ffmpeg.FS('unlink', 'out.m4a'); } catch(e){}

                } catch (e) {
                    console.error(e);
                    setStatus('error');
                    addLog(`最終失敗: ${e.message}`, 'error');
                    setShowRescue(true); // Always show rescue on total fail
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center relative overflow-hidden p-4">
                    {/* Background */}
                    <div className="absolute inset-0 bg-slate-950">
                        <div className="absolute top-[-20%] left-[-20%] w-[80vw] h-[80vw] bg-indigo-500/10 rounded-full blur-[100px] animate-blob"></div>
                        <div className="absolute bottom-[-20%] right-[-20%] w-[80vw] h-[80vw] bg-purple-500/10 rounded-full blur-[100px] animate-blob animation-delay-2000"></div>
                    </div>

                    <div className="w-full max-w-md glass rounded-2xl p-6 shadow-2xl relative z-10 border-t border-white/10">
                        <div className="text-center mb-6">
                            <div className="w-12 h-12 bg-gradient-to-tr from-indigo-500 to-purple-600 rounded-xl mx-auto flex items-center justify-center shadow-lg shadow-indigo-500/30 mb-3">
                                <Icon d={icons.zap} className="text-white" />
                            </div>
                            <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">極速轉換器 V2.4</h1>
                            <p className="text-xs text-slate-500 mt-1">Smart Switcher • Failover Protection</p>
                        </div>

                        <div className="space-y-4">
                            <div className="relative">
                                <input 
                                    value={url}
                                    onChange={e => setUrl(e.target.value)}
                                    placeholder="貼上抖音連結..."
                                    className="w-full bg-black/50 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all outline-none text-white placeholder-slate-600"
                                />
                                <button 
                                    onClick={() => navigator.clipboard.readText().then(t => setUrl(t))}
                                    className="absolute right-2 top-2 p-1.5 text-xs bg-slate-800 hover:bg-slate-700 rounded text-slate-300 transition-colors"
                                >
                                    貼上
                                </button>
                            </div>

                            {status === 'working' && (
                                <div className="space-y-3 py-2 animate-in fade-in slide-in-from-bottom-1">
                                    {videoInfo && (
                                        <div className="flex items-center gap-3 bg-slate-800/50 p-2 rounded-lg border border-slate-700/50">
                                            <img src={videoInfo.cover} className="w-10 h-10 rounded bg-slate-700 object-cover"/>
                                            <div className="min-w-0">
                                                <p className="text-xs font-bold text-slate-200 truncate">{videoInfo.title}</p>
                                                <p className="text-[10px] text-slate-500">@{videoInfo.author}</p>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="relative pt-1">
                                        <div className="flex mb-2 items-center justify-between">
                                            <div className="text-xs font-semibold inline-block text-indigo-300">
                                                {Math.round(progress)}%
                                            </div>
                                        </div>
                                        <div className="overflow-hidden h-2 mb-2 text-xs flex rounded bg-slate-800">
                                            <div style={{ width: `${progress}%` }} className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-indigo-500 to-purple-500 progress-bar"></div>
                                        </div>
                                    </div>

                                    {/* Log Console */}
                                    <div className="log-area h-28 overflow-y-auto bg-black/40 rounded-lg p-2 text-[10px] font-mono border border-white/5">
                                        {logs.map((log, i) => (
                                            <div key={i} className={`mb-1 ${
                                                log.type === 'error' ? 'text-red-400' : 
                                                log.type === 'success' ? 'text-green-400' : 'text-slate-400'
                                            }`}>
                                                <span className="opacity-50">[{log.time}]</span> {log.text}
                                            </div>
                                        ))}
                                        <div ref={el => el && el.scrollIntoView({ behavior: "smooth" })} />
                                    </div>
                                </div>
                            )}

                            {(status === 'error' || showRescue) && videoInfo && (
                                <div className="bg-yellow-500/10 border border-yellow-500/20 text-yellow-200 text-xs p-3 rounded-lg flex flex-col gap-2">
                                    <div className="font-bold flex items-center gap-2">
                                        <Icon d={icons.alert} className="text-yellow-500"/> 下載遇到困難？
                                    </div>
                                    <a 
                                        href={`https://corsproxy.io/?${encodeURIComponent(videoInfo.rawUrl)}`} 
                                        target="_blank"
                                        className="block w-full py-2 bg-yellow-500/20 hover:bg-yellow-500/30 text-center rounded border border-yellow-500/30 transition-colors"
                                    >
                                        <Icon d={icons.external} size={12} className="inline mr-1"/> 點此手動下載原始檔
                                    </a>
                                </div>
                            )}

                            {status === 'done' && downloadLink && (
                                <a 
                                    href={downloadLink}
                                    download={`${videoInfo?.title ? videoInfo.title.substring(0,20).replace(/[^\w\u4e00-\u9fa5]/g, '') : 'audio'}.m4a`}
                                    className="block w-full py-3 bg-emerald-500 hover:bg-emerald-400 text-white font-bold rounded-xl text-center shadow-lg shadow-emerald-500/20 transition-all flex items-center justify-center gap-2 animate-bounce-short"
                                >
                                    <Icon d={icons.download} /> 下載 ALAC 音訊
                                </a>
                            )}

                            {status !== 'working' && status !== 'done' && (
                                <button 
                                    onClick={process}
                                    disabled={!url}
                                    className={`w-full py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 ${
                                        url 
                                        ? 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:scale-[1.02] shadow-lg shadow-indigo-500/20 text-white' 
                                        : 'bg-slate-800 text-slate-500 cursor-not-allowed'
                                    }`}
                                >
                                    <Icon d={icons.zap} size={18} /> 開始轉換
                                </button>
                            )}
                            
                            {status === 'done' && (
                                <button onClick={() => { setStatus('idle'); setUrl(''); setProgress(0); setLogs([]); }} className="w-full text-xs text-slate-500 hover:text-white py-2">
                                    轉換下一首
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DouyinConverter />);
    </script>
</body>
</html>