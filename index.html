<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Douyin to ALAC (Speed Demon V2.1)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FFmpeg -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <style>
        @keyframes pulse-fast { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-fast { animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .progress-bar { transition: width 0.2s linear; }
    </style>
</head>
<body class="bg-black text-slate-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Icons
        const Icon = ({ d, size=24, className="" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{__html:d}} />;
        const icons = {
            zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
            download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>',
            loader: '<path d="M21 12a9 9 0 1 1-6.219-8.56"/>',
            check: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'
        };

        const DouyinConverter = () => {
            const [url, setUrl] = useState('');
            const [status, setStatus] = useState('idle');
            const [msg, setMsg] = useState('');
            const [progress, setProgress] = useState(0); // 0-100
            const [videoInfo, setVideoInfo] = useState(null);
            const [downloadLink, setDownloadLink] = useState(null);
            
            const ffmpegRef = useRef(null);
            const ffmpegReady = useRef(false);
            const maxDownloadProgress = useRef(0);

            // 1. FFmpeg Preload
            useEffect(() => {
                const initFFmpeg = async () => {
                    if (window.FFmpeg && !ffmpegRef.current) {
                        try {
                            const { createFFmpeg } = window.FFmpeg;
                            const ffmpeg = createFFmpeg({ 
                                log: false, 
                                corePath: 'https://unpkg.com/@ffmpeg/core-st@0.11.1/dist/ffmpeg-core.js',
                                mainName: 'main'
                            });
                            ffmpegRef.current = ffmpeg;
                            await ffmpeg.load();
                            ffmpegReady.current = true;
                            console.log("FFmpeg Ready");
                        } catch (e) { console.error("Preload Error", e); }
                    }
                };
                setTimeout(initFFmpeg, 500);
            }, []);

            // Helper: Robust JSON Fetcher (Proxy + Timeout)
            const fetchJsonSafe = async (targetUrl) => {
                // Try direct first, then proxies
                const strategies = [
                    u => u, // Direct
                    u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
                    u => `https://corsproxy.io/?${encodeURIComponent(u)}`
                ];

                for (const strat of strategies) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout
                        
                        const res = await fetch(strat(targetUrl), { signal: controller.signal });
                        clearTimeout(timeoutId);
                        
                        if (res.ok) return await res.json();
                    } catch (e) { continue; }
                }
                throw new Error('Connect Fail');
            };

            // 2. Download with Progress Stream
            const downloadWithRace = async (videoUrl) => {
                const secureUrl = videoUrl.replace('http:', 'https:');
                maxDownloadProgress.current = 0;

                const proxies = [
                    u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
                    u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
                    u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`
                ];

                const requests = proxies.map(proxyFn => 
                    new Promise(async (resolve, reject) => {
                        try {
                            const res = await fetch(proxyFn(secureUrl));
                            if (!res.ok) throw new Error('Net Error');
                            
                            const contentLength = res.headers.get('content-length');
                            const total = contentLength ? parseInt(contentLength, 10) : 0;
                            let loaded = 0;

                            const reader = res.body.getReader();
                            const chunks = [];

                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;
                                
                                chunks.push(value);
                                loaded += value.length;

                                if (total) {
                                    const dlPercent = (loaded / total) * 100;
                                    if (dlPercent > maxDownloadProgress.current) {
                                        maxDownloadProgress.current = dlPercent;
                                        // Map download 0-100 to UI 30-80
                                        const uiProgress = 30 + (dlPercent * 0.5); 
                                        setProgress(uiProgress);
                                        setMsg(`競速下載中... ${Math.round(dlPercent)}%`);
                                    }
                                }
                            }

                            const buffer = new Uint8Array(loaded);
                            let position = 0;
                            for(let chunk of chunks) {
                                buffer.set(chunk, position);
                                position += chunk.length;
                            }
                            resolve(buffer.buffer);

                        } catch (e) { reject(e); }
                    })
                );

                try {
                    const winnerBuffer = await Promise.any(requests);
                    return winnerBuffer;
                } catch (err) {
                    throw new Error("所有線路下載失敗");
                }
            };

            const process = async () => {
                const linkMatch = url.match(/(https?:\/\/[^\s]+)/);
                if (!linkMatch) return setMsg('無效連結');
                const cleanUrl = linkMatch[0];

                setStatus('working');
                setProgress(5);
                setDownloadLink(null);

                try {
                    // Step A: API Parsing (Multi-source Race)
                    setMsg('解析影片資訊 (智慧線路)...');
                    
                    const providers = [
                        // Source 1: Peark
                        async () => {
                            const d = await fetchJsonSafe(`https://api.pearktrue.cn/api/video/douyin/?url=${encodeURIComponent(cleanUrl)}`);
                            if(d.code !== 200) throw new Error('Peark Fail');
                            return { url: d.data.url, title: d.data.title, cover: d.data.cover, author: d.data.author };
                        },
                        // Source 2: Kuaishou
                        async () => {
                            const d = await fetchJsonSafe(`https://api.kuaishouapi.com/douyin/index?url=${encodeURIComponent(cleanUrl)}`);
                            if(d.code !== 200) throw new Error('Kuaishou Fail');
                            return { url: d.data.url||d.data.play, title: d.data.desc, cover: d.data.cover, author: d.data.author };
                        },
                        // Source 3: TenAPI
                        async () => {
                            const d = await fetchJsonSafe(`https://tenapi.cn/v2/video?url=${encodeURIComponent(cleanUrl)}`);
                            if(d.code !== 200) throw new Error('TenAPI Fail');
                            return { url: d.data.url, title: d.data.title, cover: d.data.cover, author: d.data.author };
                        }
                    ];

                    const videoData = await Promise.any(providers.map(p => p()));
                    const playUrl = videoData.url;
                    if (!playUrl) throw new Error('解析失敗: 無法取得影片連結');

                    setVideoInfo({
                        title: videoData.title || 'Unknown Title',
                        cover: videoData.cover,
                        author: videoData.author || 'Douyin User'
                    });
                    
                    setProgress(30);

                    // Step B: Download
                    const buffer = await downloadWithRace(playUrl);

                    // Step C: Convert
                    setProgress(80);
                    setMsg('啟動轉碼引擎 (FFmpeg)...');
                    
                    if (!ffmpegReady.current) {
                        if (!ffmpegRef.current) {
                             const { createFFmpeg } = window.FFmpeg;
                             ffmpegRef.current = createFFmpeg({ log: false, corePath: 'https://unpkg.com/@ffmpeg/core-st@0.11.1/dist/ffmpeg-core.js', mainName: 'main' });
                        }
                        if (!ffmpegRef.current.isLoaded()) await ffmpegRef.current.load();
                    }

                    const ffmpeg = ffmpegRef.current;
                    ffmpeg.FS('writeFile', 'in.mp4', new Uint8Array(buffer));
                    
                    setMsg('正在轉為 Apple Lossless...');
                    await ffmpeg.run('-i', 'in.mp4', '-vn', '-c:a', 'alac', 'out.m4a');

                    const data = ffmpeg.FS('readFile', 'out.m4a');
                    const blob = new Blob([data.buffer], { type: 'audio/mp4' });
                    setDownloadLink(URL.createObjectURL(blob));
                    
                    setProgress(100);
                    setStatus('done');
                    setMsg('完成！');

                    try {
                        ffmpeg.FS('unlink', 'in.mp4');
                        ffmpeg.FS('unlink', 'out.m4a');
                    } catch(e) {}

                } catch (e) {
                    console.error(e);
                    setStatus('error');
                    setMsg('失敗: ' + (e.message || '請確認連結有效或稍後再試'));
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center relative overflow-hidden p-4">
                    {/* Background */}
                    <div className="absolute inset-0 bg-slate-950">
                        <div className="absolute top-[-20%] left-[-20%] w-[80vw] h-[80vw] bg-indigo-500/10 rounded-full blur-[100px] animate-blob"></div>
                        <div className="absolute bottom-[-20%] right-[-20%] w-[80vw] h-[80vw] bg-purple-500/10 rounded-full blur-[100px] animate-blob animation-delay-2000"></div>
                    </div>

                    <div className="w-full max-w-md glass rounded-2xl p-6 shadow-2xl relative z-10 border-t border-white/10">
                        <div className="text-center mb-6">
                            <div className="w-12 h-12 bg-gradient-to-tr from-indigo-500 to-purple-600 rounded-xl mx-auto flex items-center justify-center shadow-lg shadow-indigo-500/30 mb-3">
                                <Icon d={icons.zap} className="text-white" />
                            </div>
                            <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">極速轉換器 V2.1</h1>
                            <p className="text-xs text-slate-500 mt-1">Smart Proxy Routing • High Speed</p>
                        </div>

                        <div className="space-y-4">
                            <div className="relative">
                                <input 
                                    value={url}
                                    onChange={e => setUrl(e.target.value)}
                                    placeholder="貼上抖音連結..."
                                    className="w-full bg-black/50 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all outline-none text-white placeholder-slate-600"
                                />
                                <button 
                                    onClick={() => navigator.clipboard.readText().then(t => setUrl(t))}
                                    className="absolute right-2 top-2 p-1.5 text-xs bg-slate-800 hover:bg-slate-700 rounded text-slate-300 transition-colors"
                                >
                                    貼上
                                </button>
                            </div>

                            {status === 'working' && (
                                <div className="space-y-3 py-2 animate-in fade-in slide-in-from-bottom-1">
                                    {videoInfo && (
                                        <div className="flex items-center gap-3 bg-slate-800/50 p-2 rounded-lg border border-slate-700/50">
                                            <img src={videoInfo.cover} className="w-10 h-10 rounded bg-slate-700 object-cover"/>
                                            <div className="min-w-0">
                                                <p className="text-xs font-bold text-slate-200 truncate">{videoInfo.title}</p>
                                                <p className="text-[10px] text-slate-500">@{videoInfo.author}</p>
                                            </div>
                                        </div>
                                    )}
                                    
                                    <div className="relative pt-1">
                                        <div className="flex mb-2 items-center justify-between">
                                            <div className="text-xs font-semibold inline-block text-indigo-300">
                                                {msg}
                                            </div>
                                        </div>
                                        <div className="overflow-hidden h-2 mb-4 text-xs flex rounded bg-slate-800">
                                            <div style={{ width: `${progress}%` }} className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-indigo-500 to-purple-500 progress-bar"></div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {status === 'error' && (
                                <div className="bg-red-500/10 border border-red-500/20 text-red-300 text-xs p-3 rounded-lg text-center">
                                    {msg}
                                </div>
                            )}

                            {status === 'done' && downloadLink && (
                                <a 
                                    href={downloadLink}
                                    download={`${videoInfo?.title ? videoInfo.title.substring(0,20).replace(/[^\w\u4e00-\u9fa5]/g, '') : 'audio'}.m4a`}
                                    className="block w-full py-3 bg-emerald-500 hover:bg-emerald-400 text-white font-bold rounded-xl text-center shadow-lg shadow-emerald-500/20 transition-all flex items-center justify-center gap-2 animate-bounce-short"
                                >
                                    <Icon d={icons.download} /> 下載 ALAC 音訊
                                </a>
                            )}

                            {status !== 'working' && status !== 'done' && (
                                <button 
                                    onClick={process}
                                    disabled={!url}
                                    className={`w-full py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 ${
                                        url 
                                        ? 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:scale-[1.02] shadow-lg shadow-indigo-500/20 text-white' 
                                        : 'bg-slate-800 text-slate-500 cursor-not-allowed'
                                    }`}
                                >
                                    <Icon d={icons.zap} size={18} /> 開始轉換
                                </button>
                            )}
                            
                            {status === 'done' && (
                                <button onClick={() => { setStatus('idle'); setUrl(''); setProgress(0); }} className="w-full text-xs text-slate-500 hover:text-white py-2">
                                    轉換下一首
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DouyinConverter />);
    </script>
</body>
</html>